#!/usr/bin/env bash
set -euo pipefail

# ==============================================================================
# otto — Personal Assistant Management Script
# Manages the OpenCode backend. Works on macOS (launchd) and Linux (systemd).
# ==============================================================================

OTTO_VERSION="0.2.0"

# --- Configuration -----------------------------------------------------------
OTTO_PORT="${OTTO_PORT:-4096}"
OTTO_HOSTNAME="${OTTO_HOSTNAME:-0.0.0.0}"
OTTO_HOME="${OTTO_HOME:-$HOME/.otto}"
OTTO_INBOX="${OTTO_HOME}/inbox"
OTTO_DATA="${OTTO_HOME}/data"
OTTO_SCRIPTS="${OTTO_HOME}/scripts"
OTTO_SECRETS="${OTTO_HOME}/secrets"
OTTO_LOG_DIR="${OTTO_HOME}/logs"
OTTO_SERVICE_NAME="otto"
OTTO_AGENT="${OTTO_AGENT:-assistant}"
OTTO_BRIDGE_SERVICE_NAME="otto-telegram-bridge"
OTTO_BRIDGE_ENABLED="${OTTO_BRIDGE_ENABLED:-1}"
OTTO_BRIDGE_MAC_LABEL="com.opencode.telegram-bridge"

# Resolve directory where the otto script and its companion files live
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# --- Platform Detection ------------------------------------------------------
OS="$(uname -s)"
case "$OS" in
  Darwin) PLATFORM="macos" ;;
  Linux)  PLATFORM="linux" ;;
  *)      echo "Unsupported OS: $OS" >&2; exit 1 ;;
esac

# --- Colors & Output ---------------------------------------------------------
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[0;33m'
BLUE=$'\033[0;34m'
BOLD=$'\033[1m'
NC=$'\033[0m'

info()    { echo "${BLUE}[otto]${NC} $*"; }
success() { echo "${GREEN}[otto]${NC} $*"; }
warn()    { echo "${YELLOW}[otto]${NC} $*"; }
error()   { echo "${RED}[otto]${NC} $*" >&2; }

# --- Helpers -----------------------------------------------------------------
require_cmd() {
  if ! command -v "$1" &>/dev/null; then
    error "Required command '$1' not found. Please install it first."
    exit 1
  fi
}

install_bridge_if_missing() {
  if command -v opencode-telegram-bridge >/dev/null 2>&1; then
    return 0
  fi

  info "Installing opencode-telegram-bridge..."
  require_cmd node
  require_cmd npm

  if npm install -g opencode-telegram-bridge; then
    success "  opencode-telegram-bridge installed"
  else
    error "Failed to install opencode-telegram-bridge."
    error "Install manually: npm install -g opencode-telegram-bridge"
    exit 1
  fi
}

detect_shell_rc_file() {
  local shell_name
  shell_name="$(basename "${SHELL:-}")"

  case "$shell_name" in
    zsh)
      echo "${HOME}/.zshrc"
      ;;
    bash)
      echo "${HOME}/.bashrc"
      ;;
    *)
      if [[ -f "${HOME}/.zshrc" ]]; then
        echo "${HOME}/.zshrc"
      else
        echo "${HOME}/.bashrc"
      fi
      ;;
  esac
}

upsert_shell_export() {
  local rc_file="$1"
  local var_name="$2"
  local value="$3"
  local escaped_value
  escaped_value="${value//\\/\\\\}"
  escaped_value="${escaped_value//\"/\\\"}"

  touch "$rc_file"

  if grep -Eq "^[[:space:]]*export[[:space:]]+${var_name}=" "$rc_file"; then
    local tmp
    tmp="$(mktemp)"
    awk -v var_name="$var_name" -v new_value="$escaped_value" '
      BEGIN { replaced = 0 }
      {
        if (!replaced && $0 ~ "^[[:space:]]*export[[:space:]]+" var_name "=") {
          print "export " var_name "=\"" new_value "\""
          replaced = 1
        } else {
          print $0
        }
      }
      END {
        if (!replaced) {
          print "export " var_name "=\"" new_value "\""
        }
      }
    ' "$rc_file" > "$tmp"
    mv "$tmp" "$rc_file"
  else
    cat >> "$rc_file" <<EOF
export ${var_name}="${escaped_value}"
EOF
  fi
}

configure_google_env_vars() {
  local rc_file
  local current_client_id="${GOOGLE_CLIENT_ID:-}"
  local current_client_secret="${GOOGLE_CLIENT_SECRET:-}"
  local current_oauth_path="${GOOGLE_OAUTH_CREDENTIALS:-${OTTO_SECRETS}/gcp-oauth.keys.json}"
  local input_client_id
  local input_client_secret
  local input_oauth_path

  rc_file="$(detect_shell_rc_file)"

  info "Configuring Google credentials in ${rc_file}..."

  read -rp "Google OAuth Client ID [${current_client_id}]: " input_client_id
  if [[ -z "$input_client_id" ]]; then
    input_client_id="$current_client_id"
  fi

  if [[ -n "$current_client_secret" ]]; then
    read -rsp "Google OAuth Client Secret [hidden, press enter to keep]: " input_client_secret
    echo ""
  else
    read -rsp "Google OAuth Client Secret: " input_client_secret
    echo ""
  fi
  if [[ -z "$input_client_secret" ]]; then
    input_client_secret="$current_client_secret"
  fi

  read -rp "Path to Google OAuth credentials JSON [${current_oauth_path}]: " input_oauth_path
  if [[ -z "$input_oauth_path" ]]; then
    input_oauth_path="$current_oauth_path"
  fi

  if [[ -n "$input_oauth_path" && -f "$input_oauth_path" ]]; then
    cp "$input_oauth_path" "${OTTO_SECRETS}/gcp-oauth.keys.json"
    chmod 600 "${OTTO_SECRETS}/gcp-oauth.keys.json"
    input_oauth_path="${OTTO_SECRETS}/gcp-oauth.keys.json"
    success "  OAuth credentials copied to ${input_oauth_path}"
  elif [[ -n "$input_oauth_path" ]]; then
    warn "  Credentials file not found at ${input_oauth_path}; keeping path as-is"
  fi

  upsert_shell_export "$rc_file" "GOOGLE_CLIENT_ID" "$input_client_id"
  upsert_shell_export "$rc_file" "GOOGLE_CLIENT_SECRET" "$input_client_secret"
  upsert_shell_export "$rc_file" "GOOGLE_OAUTH_CREDENTIALS" "$input_oauth_path"
  success "  Google environment variables updated"
  info "Reload your shell after setup: source ${rc_file}"
}

# --- Platform: Service Management --------------------------------------------
# Each platform implements: svc_install, svc_uninstall, svc_start, svc_stop,
# svc_restart, svc_is_running, svc_enable, svc_logs

if [[ "$PLATFORM" == "macos" ]]; then

  PLIST_LABEL="com.otto.assistant"
  PLIST_FILE="${HOME}/Library/LaunchAgents/${PLIST_LABEL}.plist"

  svc_install() {
    local opencode_path="$1"

    mkdir -p "${HOME}/Library/LaunchAgents"

    cat > "$PLIST_FILE" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${PLIST_LABEL}</string>
    <key>ProgramArguments</key>
    <array>
        <string>${opencode_path}</string>
        <string>serve</string>
        <string>--port</string>
        <string>${OTTO_PORT}</string>
        <string>--hostname</string>
        <string>${OTTO_HOSTNAME}</string>
    </array>
    <key>WorkingDirectory</key>
    <string>${OTTO_HOME}</string>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    <key>StandardOutPath</key>
    <string>${OTTO_LOG_DIR}/otto.log</string>
    <key>StandardErrorPath</key>
    <string>${OTTO_LOG_DIR}/otto.err.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>OTTO_HOME</key>
        <string>${OTTO_HOME}</string>
        <key>PATH</key>
        <string>/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin</string>
    </dict>
</dict>
</plist>
EOF
    success "  Plist: $PLIST_FILE"
  }

  svc_uninstall() {
    launchctl bootout "gui/$(id -u)" "$PLIST_FILE" 2>/dev/null || true
    rm -f "$PLIST_FILE"
  }

  svc_start() {
    launchctl bootstrap "gui/$(id -u)" "$PLIST_FILE"
  }

  svc_stop() {
    launchctl bootout "gui/$(id -u)" "$PLIST_FILE" 2>/dev/null || true
  }

  svc_restart() {
    svc_stop
    sleep 1
    svc_install "$(command -v opencode)"
    svc_start
  }

  svc_is_running() {
    launchctl print "gui/$(id -u)/${PLIST_LABEL}" &>/dev/null
  }

  svc_enable() {
    # launchd services with RunAtLoad are auto-enabled
    success "  Service will start on login (RunAtLoad)"
  }

  svc_logs() {
    local lines="${1:-50}"
    info "Tailing logs (Ctrl+C to stop)..."
    echo ""
    echo "=== stdout: ${OTTO_LOG_DIR}/otto.log ==="
    tail -n "$lines" "${OTTO_LOG_DIR}/otto.log" 2>/dev/null || warn "No stdout log yet"
    echo ""
    echo "=== stderr: ${OTTO_LOG_DIR}/otto.err.log ==="
    tail -n "$lines" "${OTTO_LOG_DIR}/otto.err.log" 2>/dev/null || warn "No stderr log yet"
    echo ""
    info "Following both logs..."
    tail -f "${OTTO_LOG_DIR}/otto.log" "${OTTO_LOG_DIR}/otto.err.log" 2>/dev/null
  }

elif [[ "$PLATFORM" == "linux" ]]; then

  SYSTEMD_USER_DIR="${HOME}/.config/systemd/user"
  SERVICE_FILE="${SYSTEMD_USER_DIR}/${OTTO_SERVICE_NAME}.service"

  svc_install() {
    local opencode_path="$1"

    mkdir -p "$SYSTEMD_USER_DIR"

    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Otto — Personal Assistant (OpenCode Backend)
After=network.target

[Service]
Type=simple
ExecStart=${opencode_path} serve --port ${OTTO_PORT} --hostname ${OTTO_HOSTNAME}
WorkingDirectory=${OTTO_HOME}
Restart=on-failure
RestartSec=5
Environment=OTTO_HOME=${OTTO_HOME}
StandardOutput=journal
StandardError=journal
SyslogIdentifier=otto

[Install]
WantedBy=default.target
EOF
    success "  Service file: $SERVICE_FILE"
  }

  svc_uninstall() {
    systemctl --user disable "$OTTO_SERVICE_NAME" 2>/dev/null || true
    rm -f "$SERVICE_FILE"
    systemctl --user daemon-reload
  }

  svc_start() {
    systemctl --user start "$OTTO_SERVICE_NAME"
  }

  svc_stop() {
    systemctl --user stop "$OTTO_SERVICE_NAME"
  }

  svc_restart() {
    systemctl --user restart "$OTTO_SERVICE_NAME"
  }

  svc_is_running() {
    systemctl --user is-active --quiet "$OTTO_SERVICE_NAME" 2>/dev/null
  }

  svc_enable() {
    systemctl --user daemon-reload
    systemctl --user enable "$OTTO_SERVICE_NAME"
    success "  Service enabled (will start on boot)"

    info "Enabling user lingering (services run even when logged out)..."
    if loginctl enable-linger "$(whoami)" 2>/dev/null; then
      success "  Lingering enabled for $(whoami)"
    else
      warn "  Could not enable lingering. Run: sudo loginctl enable-linger $(whoami)"
    fi
  }

  svc_logs() {
    local lines="${1:-50}"
    journalctl --user -u "$OTTO_SERVICE_NAME" -n "$lines" --no-pager -f
  }

fi

# --- Telegram Bridge Management ----------------------------------------------

bridge_requested() {
  [[ "$OTTO_BRIDGE_ENABLED" == "1" ]]
}

bridge_service_installed() {
  if [[ "$PLATFORM" == "linux" ]]; then
    local load_state
    load_state="$(systemctl --user show -p LoadState --value "$OTTO_BRIDGE_SERVICE_NAME" 2>/dev/null || true)"
    [[ -n "$load_state" && "$load_state" != "not-found" ]]
  else
    [[ -f "${HOME}/Library/LaunchAgents/${OTTO_BRIDGE_MAC_LABEL}.plist" ]]
  fi
}

bridge_is_running() {
  if ! bridge_service_installed; then
    return 1
  fi

  if [[ "$PLATFORM" == "linux" ]]; then
    systemctl --user is-active --quiet "$OTTO_BRIDGE_SERVICE_NAME" 2>/dev/null
  else
    launchctl print "gui/$(id -u)/${OTTO_BRIDGE_MAC_LABEL}" &>/dev/null
  fi
}

bridge_start() {
  if ! bridge_requested; then
    return 0
  fi

  if ! bridge_service_installed; then
    warn "Telegram bridge service not installed. Run: otto bridge-setup"
    return 0
  fi

  if bridge_is_running; then
    success "Telegram bridge is already running."
    return 0
  fi

  info "Starting Telegram bridge..."
  if [[ "$PLATFORM" == "linux" ]]; then
    systemctl --user start "$OTTO_BRIDGE_SERVICE_NAME"
  else
    local plist
    plist="${HOME}/Library/LaunchAgents/${OTTO_BRIDGE_MAC_LABEL}.plist"
    launchctl bootstrap "gui/$(id -u)" "$plist" 2>/dev/null || true
    launchctl enable "gui/$(id -u)/${OTTO_BRIDGE_MAC_LABEL}" 2>/dev/null || true
    launchctl kickstart -k "gui/$(id -u)/${OTTO_BRIDGE_MAC_LABEL}"
  fi

  sleep 1
  if bridge_is_running; then
    success "Telegram bridge started."
  else
    warn "Telegram bridge failed to start. Check bridge logs."
  fi
}

bridge_stop() {
  if ! bridge_requested; then
    return 0
  fi

  if ! bridge_service_installed; then
    return 0
  fi

  if ! bridge_is_running; then
    return 0
  fi

  info "Stopping Telegram bridge..."
  if [[ "$PLATFORM" == "linux" ]]; then
    systemctl --user stop "$OTTO_BRIDGE_SERVICE_NAME"
  else
    local plist
    plist="${HOME}/Library/LaunchAgents/${OTTO_BRIDGE_MAC_LABEL}.plist"
    launchctl bootout "gui/$(id -u)" "$plist" 2>/dev/null || \
      launchctl bootout "gui/$(id -u)/${OTTO_BRIDGE_MAC_LABEL}" 2>/dev/null || true
  fi
  success "Telegram bridge stopped."
}

bridge_restart() {
  if ! bridge_requested; then
    return 0
  fi

  if ! bridge_service_installed; then
    warn "Telegram bridge service not installed. Run: otto bridge-setup"
    return 0
  fi

  info "Restarting Telegram bridge..."
  if [[ "$PLATFORM" == "linux" ]]; then
    systemctl --user restart "$OTTO_BRIDGE_SERVICE_NAME"
  else
    launchctl kickstart -k "gui/$(id -u)/${OTTO_BRIDGE_MAC_LABEL}"
  fi
  sleep 1
  if bridge_is_running; then
    success "Telegram bridge restarted."
  else
    warn "Telegram bridge restart failed. Check bridge logs."
  fi
}

bridge_setup() {
  require_cmd opencode-telegram-bridge
  info "Running Telegram bridge setup wizard..."
  opencode-telegram-bridge setup
}

bridge_logs() {
  local lines="${1:-50}"
  if [[ "$PLATFORM" == "linux" ]]; then
    journalctl --user -u "$OTTO_BRIDGE_SERVICE_NAME" -n "$lines" --no-pager -f
  else
    tail -n "$lines" "${HOME}/Library/Logs/opencode-telegram-bridge.log" 2>/dev/null || \
      warn "No bridge log yet at ~/Library/Logs/opencode-telegram-bridge.log"
  fi
}

# --- Commands ----------------------------------------------------------------

cmd_setup() {
  info "Setting up Otto v${OTTO_VERSION} on ${PLATFORM}..."
  echo ""

  # Check prerequisites
  info "Checking prerequisites..."
  require_cmd opencode
  success "  opencode: $(command -v opencode)"
  if bridge_requested; then
    install_bridge_if_missing
    success "  opencode-telegram-bridge: $(command -v opencode-telegram-bridge)"
  fi
  success "  platform: ${PLATFORM}"
  echo ""

  # Create directory structure
  info "Creating directory structure..."
  mkdir -p "$OTTO_HOME" "$OTTO_INBOX" "$OTTO_DATA" "$OTTO_SCRIPTS" "$OTTO_SECRETS" "$OTTO_LOG_DIR"
  success "  $OTTO_HOME"
  success "  $OTTO_INBOX"
  success "  $OTTO_DATA"
  success "  $OTTO_SCRIPTS"
  success "  $OTTO_SECRETS"
  success "  $OTTO_LOG_DIR"
  echo ""

  # Configure Google environment exports (idempotent upsert)
  configure_google_env_vars
  echo ""

  # Deploy OpenCode config files into OTTO_HOME (project-level config)
  info "Deploying OpenCode configuration..."
  local config_files=("opencode.jsonc" "AGENTS.md")
  for f in "${config_files[@]}"; do
    if [[ -f "${SCRIPT_DIR}/${f}" ]]; then
      cp "${SCRIPT_DIR}/${f}" "${OTTO_HOME}/${f}"
      success "  ${OTTO_HOME}/${f}"
    else
      warn "  Missing: ${SCRIPT_DIR}/${f} — skipping"
    fi
  done

  # Deploy agent prompt
  if [[ -d "${SCRIPT_DIR}/agents" ]]; then
    mkdir -p "${OTTO_HOME}/agents"
    cp "${SCRIPT_DIR}/agents/"*.md "${OTTO_HOME}/agents/" 2>/dev/null
    success "  ${OTTO_HOME}/agents/"
  else
    warn "  Missing: ${SCRIPT_DIR}/agents/ — skipping"
  fi
  echo ""

  # Resolve opencode path for service file
  local opencode_path
  opencode_path="$(command -v opencode)"

  # Install platform service
  info "Installing service..."
  svc_install "$opencode_path"
  echo ""

  # Enable service
  info "Enabling service..."
  svc_enable
  echo ""

  # Write config file
  info "Writing config to ${OTTO_HOME}/otto.conf..."
  cat > "${OTTO_HOME}/otto.conf" <<EOF
# Otto configuration
OTTO_PORT=${OTTO_PORT}
OTTO_HOSTNAME=${OTTO_HOSTNAME}
OTTO_AGENT=${OTTO_AGENT}
OTTO_VERSION=${OTTO_VERSION}
PLATFORM=${PLATFORM}
EOF
  success "  Config written"
  echo ""

  # Bridge setup (interactive wizard)
  if bridge_requested; then
    if bridge_service_installed; then
      info "Telegram bridge appears configured; skipping bridge setup wizard."
      info "Use 'otto bridge-setup' to reconfigure it."
    else
      info "Configuring Telegram bridge..."
      info "You'll be prompted for TELEGRAM_BOT_TOKEN and TELEGRAM_ALLOWED_USER_ID."
      bridge_setup
    fi
    echo ""
  else
    info "Telegram bridge setup skipped (OTTO_BRIDGE_ENABLED=0)."
    echo ""
  fi

  # Summary
  echo "${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo "${BOLD}  Otto setup complete! (${PLATFORM})${NC}"
  echo "${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  echo "  Next steps:"
  echo "    1. Start Otto:       otto start"
  echo "    2. On your laptop:   alias otto=\"opencode attach http://$(hostname):${OTTO_PORT}\""
  echo "    3. Try it:           otto"
  echo ""
}

cmd_start() {
  if svc_is_running; then
    warn "Otto is already running."
  else
    info "Starting Otto on port ${OTTO_PORT}..."
    svc_start
    sleep 2
    if svc_is_running; then
      success "Otto is running."
    else
      error "Failed to start Otto. Check logs: otto logs"
      exit 1
    fi
  fi

  bridge_start
  cmd_status
}

cmd_stop() {
  if svc_is_running; then
    info "Stopping Otto..."
    svc_stop
    success "Otto stopped."
  else
    warn "Otto is not running."
  fi

  bridge_stop
}

cmd_restart() {
  info "Restarting Otto..."
  svc_restart
  sleep 2
  if svc_is_running; then
    success "Otto restarted."
  else
    error "Failed to restart Otto. Check logs: otto logs"
    exit 1
  fi

  bridge_restart
  cmd_status
}

cmd_status() {
  echo ""
  if svc_is_running; then
    echo "  Status:   ${GREEN}● running${NC}"
  else
    echo "  Status:   ${RED}● stopped${NC}"
  fi
  echo "  Platform: ${PLATFORM}"
  echo "  Port:     ${OTTO_PORT}"
  echo "  Home:     ${OTTO_HOME}"
  echo "  Connect:  opencode attach http://$(hostname):${OTTO_PORT}"
  if ! bridge_requested; then
    echo "  Telegram: ${YELLOW}● management disabled${NC} (OTTO_BRIDGE_ENABLED=0)"
  else
    if bridge_service_installed; then
      if bridge_is_running; then
        echo "  Telegram: ${GREEN}● running${NC}"
      else
        echo "  Telegram: ${YELLOW}● installed, stopped${NC}"
      fi
    else
      echo "  Telegram: ${YELLOW}● not configured${NC} (run: otto bridge-setup)"
    fi
  fi
  echo ""
}

cmd_logs() {
  local target="${1:-otto}"
  local lines="${2:-50}"

  if [[ "$target" =~ ^[0-9]+$ ]]; then
    lines="$target"
    target="otto"
  fi

  case "$target" in
    otto)
      svc_logs "$lines"
      ;;
    bridge)
      bridge_logs "$lines"
      ;;
    *)
      error "Usage: otto logs [otto|bridge] [lines]"
      exit 1
      ;;
  esac
}

cmd_run() {
  if ! svc_is_running; then
    error "Otto is not running. Start with: otto start"
    exit 1
  fi
  local prompt="$*"
  if [[ -z "$prompt" ]]; then
    error "Usage: otto run <prompt>"
    exit 1
  fi
  opencode run --attach "http://localhost:${OTTO_PORT}" --agent "$OTTO_AGENT" "$prompt"
}

cmd_uninstall() {
  warn "This will stop Otto and remove the service."
  read -rp "Continue? [y/N] " confirm
  if [[ "$confirm" != [yY] ]]; then
    info "Aborted."
    return 0
  fi

  if svc_is_running; then
    cmd_stop
  fi

  bridge_stop

  svc_uninstall

  success "Otto service removed. Data in ${OTTO_HOME} was kept."
  if bridge_service_installed; then
    warn "Telegram bridge service was not removed. Manage it with: opencode-telegram-bridge setup"
  fi
  info "To fully remove: rm -rf ${OTTO_HOME}"
}

cmd_bridge_setup() {
  bridge_setup
}

cmd_help() {
  cat <<EOF

${BOLD}otto${NC} — Personal Assistant Management (v${OTTO_VERSION})

${BOLD}USAGE${NC}
    otto <command> [args]

${BOLD}COMMANDS${NC}
    setup       Initial setup: create dirs, install service
    bridge-setup  Run Telegram bridge setup wizard
    start       Start the Otto backend
    stop        Stop the Otto backend
    restart     Restart the Otto backend
    status      Show current status and connection info
    logs [target] [n]  Follow logs for otto|bridge (default: otto 50)
    run <msg>   Send a one-shot prompt to Otto
    uninstall   Remove the service (keeps data)
    help        Show this help

${BOLD}CONFIGURATION${NC}
    OTTO_PORT       Server port (default: 4096)
    OTTO_HOSTNAME   Bind address (default: 0.0.0.0)
    OTTO_HOME       Data directory (default: ~/.otto)
    OTTO_AGENT      Agent to use (default: assistant)
    OTTO_BRIDGE_ENABLED  Start/stop bridge with Otto (1 or 0, default: 1)

${BOLD}EXAMPLES${NC}
    otto setup                          # First-time setup
    otto start                          # Start the backend
    otto run "What's on my calendar?"   # One-shot prompt
    otto logs                           # Watch Otto logs
    otto logs bridge 100                # Watch Telegram bridge logs
    otto bridge-setup                   # Configure Telegram bridge service
    otto stop                           # Stop the backend

${BOLD}LAPTOP SETUP${NC}
    Add to your ~/.zshrc:
      alias otto="opencode attach http://orin:4096"

EOF
}

# --- Main --------------------------------------------------------------------

# Load config if it exists
[[ -f "${OTTO_HOME}/otto.conf" ]] && source "${OTTO_HOME}/otto.conf"

case "${1:-help}" in
  setup)     cmd_setup ;;
  bridge-setup) cmd_bridge_setup ;;
  start)     cmd_start ;;
  stop)      cmd_stop ;;
  restart)   cmd_restart ;;
  status)    cmd_status ;;
  logs)      shift; cmd_logs "$@" ;;
  run)       shift; cmd_run "$@" ;;
  uninstall) cmd_uninstall ;;
  help|--help|-h) cmd_help ;;
  *)
    error "Unknown command: $1"
    cmd_help
    exit 1
    ;;
esac
