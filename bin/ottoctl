#!/usr/bin/env bash
set -euo pipefail

OTTO_ROOT="${OTTO_ROOT:-$HOME/.local/share/otto}"
RELEASES_DIR="${OTTO_ROOT}/releases"
CURRENT_LINK="${OTTO_ROOT}/current"
INSTALL_META="${OTTO_ROOT}/install.env"
SECRETS_DIR="${OTTO_ROOT}/secrets"
TELEGRAM_ENV_FILE="${SECRETS_DIR}/telegram.env"
BIN_DIR="${OTTO_BIN_DIR:-$HOME/.local/bin}"
SERVICE_NAME="otto"
PLIST_LABEL="com.otto.assistant"
PLIST_FILE="${HOME}/Library/LaunchAgents/${PLIST_LABEL}.plist"
DEFAULT_REPO="MarcoMuellner/otto"

BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[0;33m'
RED=$'\033[0;31m'
NC=$'\033[0m'

info() { echo "${BLUE}[ottoctl]${NC} $*"; }
success() { echo "${GREEN}[ottoctl]${NC} $*"; }
warn() { echo "${YELLOW}[ottoctl]${NC} $*"; }
error() { echo "${RED}[ottoctl]${NC} $*" >&2; }

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    error "Required command '$1' not found"
    exit 1
  fi
}

detect_platform() {
  case "$(uname -s)" in
    Linux) echo "linux" ;;
    Darwin) echo "macos" ;;
    *)
      error "Unsupported platform: $(uname -s)"
      exit 1
      ;;
  esac
}

load_install_meta() {
  if [[ -f "${INSTALL_META}" ]]; then
    # shellcheck disable=SC1090
    source "${INSTALL_META}"
  fi
}

load_telegram_env() {
  if [[ -f "${TELEGRAM_ENV_FILE}" ]]; then
    # shellcheck disable=SC1090
    source "${TELEGRAM_ENV_FILE}"
  fi
}

has_telegram_credentials() {
  [[ -n "${TELEGRAM_BOT_TOKEN:-}" ]] && [[ -n "${TELEGRAM_ALLOWED_USER_ID:-}" ]]
}

is_positive_integer() {
  [[ "$1" =~ ^[0-9]+$ ]] && [[ "$1" -ge 1 ]]
}

xml_escape() {
  local value="$1"
  value="${value//&/&amp;}"
  value="${value//</&lt;}"
  value="${value//>/&gt;}"
  value="${value//\"/&quot;}"
  value="${value//\'/&apos;}"
  printf '%s' "${value}"
}

persist_telegram_credentials() {
  mkdir -p "${SECRETS_DIR}"
  chmod 700 "${SECRETS_DIR}"

cat > "${TELEGRAM_ENV_FILE}" <<EOF
TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
TELEGRAM_ALLOWED_USER_ID=${TELEGRAM_ALLOWED_USER_ID}
EOF

  chmod 600 "${TELEGRAM_ENV_FILE}"
}

prompt_telegram_credentials() {
  if [[ ! -t 0 || ! -t 1 ]]; then
    warn "Telegram credentials missing and terminal is non-interactive; skipping setup"
    return 1
  fi

  while true; do
    info "Telegram credentials are required for automatic Telegram worker startup."
    read -r -p "Configure Telegram now? [Y/n]: " configure_now

    case "${configure_now:-Y}" in
      Y|y|"")
        break
        ;;
      N|n)
        warn "Skipping Telegram credential setup for now"
        return 1
        ;;
      *)
        warn "Please answer Y or n"
        ;;
    esac
  done

  while true; do
    read -r -s -p "TELEGRAM_BOT_TOKEN: " TELEGRAM_BOT_TOKEN
    echo
    read -r -p "TELEGRAM_ALLOWED_USER_ID: " TELEGRAM_ALLOWED_USER_ID

    if [[ -z "${TELEGRAM_BOT_TOKEN}" ]]; then
      warn "TELEGRAM_BOT_TOKEN cannot be empty"
      continue
    fi

    if [[ "${TELEGRAM_BOT_TOKEN}" =~ [[:space:]] ]]; then
      warn "TELEGRAM_BOT_TOKEN cannot contain whitespace"
      continue
    fi

    if ! is_positive_integer "${TELEGRAM_ALLOWED_USER_ID}"; then
      warn "TELEGRAM_ALLOWED_USER_ID must be an integer >= 1"
      continue
    fi

    persist_telegram_credentials
    success "Saved Telegram credentials to ${TELEGRAM_ENV_FILE}"
    return 0
  done
}

ensure_telegram_credentials() {
  load_telegram_env

  if has_telegram_credentials; then
    persist_telegram_credentials
    info "Using existing Telegram credentials"
    return 0
  fi

  if prompt_telegram_credentials; then
    return 0
  fi

  return 1
}

resolve_repo() {
  local explicit_repo="${1:-}"
  if [[ -n "${explicit_repo}" ]]; then
    echo "${explicit_repo}"
    return
  fi

  if [[ -n "${OTTO_GITHUB_REPO:-}" ]]; then
    echo "${OTTO_GITHUB_REPO}"
    return
  fi

  echo "${DEFAULT_REPO}"
}

fetch_release_info() {
  local repo="$1"
  local channel="$2"

  node "${CURRENT_LINK}/scripts/resolve-release.mjs" "${repo}" "${channel}"
}

install_release() {
  local tag="$1"
  local artifact_url="$2"

  local tmp_dir
  tmp_dir="$(mktemp -d)"
  trap '[[ -n "${tmp_dir:-}" ]] && rm -rf "${tmp_dir}"' RETURN

  mkdir -p "${RELEASES_DIR}" "${BIN_DIR}"

  info "Downloading ${tag}..."
  curl -fsSL "${artifact_url}" -o "${tmp_dir}/otto.tgz"

  local release_dir="${RELEASES_DIR}/${tag}"
  rm -rf "${release_dir}"
  mkdir -p "${release_dir}"
  tar -xzf "${tmp_dir}/otto.tgz" -C "${release_dir}"

  ln -sfn "${release_dir}" "${CURRENT_LINK}"

  if [[ -f "${CURRENT_LINK}/bin/ottoctl" ]]; then
    local target_cli="${BIN_DIR}/ottoctl"
    local staged_cli="${BIN_DIR}/.ottoctl.$$"

    cp "${CURRENT_LINK}/bin/ottoctl" "${staged_cli}"
    chmod +x "${staged_cli}"
    mv -f "${staged_cli}" "${target_cli}"
    chmod +x "${BIN_DIR}/ottoctl"
  fi

  success "Installed ${tag}"
}

run_setup() {
  require_cmd node
  NODE_ENV=production node "${CURRENT_LINK}/dist/index.mjs" setup
}

install_service_linux() {
  local node_path
  node_path="$(command -v node)"
  local user_dir="${HOME}/.config/systemd/user"
  local service_file="${user_dir}/${SERVICE_NAME}.service"

  mkdir -p "${user_dir}"

  cat > "${service_file}" <<EOF
[Unit]
Description=Otto Personal Assistant
After=network.target

[Service]
Type=simple
ExecStart=${node_path} ${CURRENT_LINK}/dist/index.mjs serve
WorkingDirectory=${HOME}
Restart=on-failure
RestartSec=5
EnvironmentFile=-${TELEGRAM_ENV_FILE}
Environment=HOME=${HOME}
Environment=PATH=${PATH}
Environment=NODE_ENV=production
StandardOutput=journal
StandardError=journal
SyslogIdentifier=otto

[Install]
WantedBy=default.target
EOF

  systemctl --user daemon-reload
  systemctl --user enable "${SERVICE_NAME}" >/dev/null

  if command -v loginctl >/dev/null 2>&1; then
    loginctl enable-linger "$(whoami)" >/dev/null 2>&1 || true
  fi
}

install_service_macos() {
  local node_path
  node_path="$(command -v node)"

  mkdir -p "${HOME}/Library/LaunchAgents"

  local telegram_env_keys=""

  if [[ -n "${TELEGRAM_BOT_TOKEN:-}" ]]; then
    telegram_env_keys+="
    <key>TELEGRAM_BOT_TOKEN</key>
    <string>$(xml_escape "${TELEGRAM_BOT_TOKEN}")</string>"
  fi

  if [[ -n "${TELEGRAM_ALLOWED_USER_ID:-}" ]]; then
    telegram_env_keys+="
    <key>TELEGRAM_ALLOWED_USER_ID</key>
    <string>$(xml_escape "${TELEGRAM_ALLOWED_USER_ID}")</string>"
  fi

  cat > "${PLIST_FILE}" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>${PLIST_LABEL}</string>
  <key>ProgramArguments</key>
  <array>
    <string>${node_path}</string>
    <string>${CURRENT_LINK}/dist/index.mjs</string>
    <string>serve</string>
  </array>
  <key>WorkingDirectory</key>
  <string>${HOME}</string>
  <key>RunAtLoad</key>
  <true/>
  <key>KeepAlive</key>
  <true/>
  <key>EnvironmentVariables</key>
  <dict>
    <key>HOME</key>
    <string>${HOME}</string>
    <key>PATH</key>
    <string>${PATH}</string>
    <key>NODE_ENV</key>
    <string>production</string>
${telegram_env_keys}
  </dict>
  <key>StandardOutPath</key>
  <string>${HOME}/.local/share/otto/logs/service.log</string>
  <key>StandardErrorPath</key>
  <string>${HOME}/.local/share/otto/logs/service.err.log</string>
</dict>
</plist>
EOF
}

install_service() {
  local platform
  platform="$(detect_platform)"

  mkdir -p "${OTTO_ROOT}/logs"

  if [[ "${platform}" == "linux" ]]; then
    install_service_linux
  else
    install_service_macos
  fi
}

start_service() {
  local platform
  platform="$(detect_platform)"

  if [[ "${platform}" == "linux" ]]; then
    systemctl --user start "${SERVICE_NAME}"
  else
    launchctl bootout "gui/$(id -u)" "${PLIST_FILE}" >/dev/null 2>&1 || true
    launchctl bootstrap "gui/$(id -u)" "${PLIST_FILE}"
    launchctl kickstart -k "gui/$(id -u)/${PLIST_LABEL}"
  fi
}

stop_service() {
  local platform
  platform="$(detect_platform)"

  if [[ "${platform}" == "linux" ]]; then
    systemctl --user stop "${SERVICE_NAME}"
  else
    launchctl bootout "gui/$(id -u)" "${PLIST_FILE}" >/dev/null 2>&1 || true
  fi
}

restart_service() {
  stop_service || true
  start_service
}

write_install_meta() {
  local repo="$1"
  mkdir -p "${OTTO_ROOT}"
  cat > "${INSTALL_META}" <<EOF
OTTO_GITHUB_REPO=${repo}
OTTO_ROOT=${OTTO_ROOT}
OTTO_BIN_DIR=${BIN_DIR}
EOF
}

cmd_update() {
  local channel="stable"
  local repo_override=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --nightly)
        channel="nightly"
        shift
        ;;
      --repo)
        repo_override="${2:-}"
        shift 2
        ;;
      *)
        error "Unknown option for update: $1"
        exit 1
        ;;
    esac
  done

  local repo
  repo="$(resolve_repo "${repo_override}")"

  local release_info
  release_info="$(fetch_release_info "${repo}" "${channel}")"
  local tag artifact_url artifact_name
  tag="$(printf '%s\n' "${release_info}" | sed -n '1p')"
  artifact_url="$(printf '%s\n' "${release_info}" | sed -n '2p')"
  artifact_name="$(printf '%s\n' "${release_info}" | sed -n '3p')"

  info "Using artifact ${artifact_name} (${tag})"

  install_release "${tag}" "${artifact_url}"
  write_install_meta "${repo}"
  run_setup
  ensure_telegram_credentials || true
  install_service
  restart_service

  success "Otto updated to ${tag}"
}

cmd_start() {
  install_service
  start_service
  success "Otto service started"
}

cmd_stop() {
  stop_service
  success "Otto service stopped"
}

cmd_configure_telegram() {
  if ensure_telegram_credentials; then
    success "Telegram credential setup complete"
  else
    warn "Telegram credential setup skipped"
  fi
}

cmd_help() {
  cat <<'EOF'
ottoctl - Otto server control

Usage:
  ottoctl start
  ottoctl stop
  ottoctl configure-telegram
  ottoctl update [--nightly] [--repo owner/repo]
EOF
}

main() {
  require_cmd curl
  require_cmd tar
  require_cmd node

  load_install_meta
  load_telegram_env

  case "${1:-help}" in
    start)
      shift
      cmd_start "$@"
      ;;
    stop)
      shift
      cmd_stop "$@"
      ;;
    configure-telegram)
      shift
      cmd_configure_telegram "$@"
      ;;
    update)
      shift
      cmd_update "$@"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      error "Unknown command: $1"
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
