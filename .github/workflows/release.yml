name: Release

on:
  push:
    branches:
      - main
    paths:
      - "packages/otto/src/**"
      - "packages/otto/tests/**"
      - "packages/otto/scripts/**"
      - "packages/otto/bin/ottoctl"
      - "packages/otto/install.sh"
      - "packages/otto/package.json"
      - "packages/otto/README.md"
      - "packages/otto/tsconfig.json"
      - "packages/otto/tsdown.config.ts"
      - "packages/otto/vitest.config.ts"
      - "packages/otto/.prettierrc.json"
      - "packages/otto/.oxlintrc.json"
      - "packages/otto-control-plane/**"
      - "packages/otto-extension-sdk/**"
      - "install.sh"
      - "pnpm-lock.yaml"
      - "scripts/resolve-release.mjs"
      - ".github/workflows/release.yml"
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and publish release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Compute release metadata
        id: meta
        shell: bash
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG_NAME="${GITHUB_REF_NAME}"
            VERSION="${GITHUB_REF_NAME#v}"
            RELEASE_NAME="Otto ${GITHUB_REF_NAME}"
            PRERELEASE="false"
          else
            TIMESTAMP="$(date -u +%Y%m%d%H%M%S)"
            TAG_NAME="nightly-${TIMESTAMP}-${SHORT_SHA}"
            PACKAGE_VERSION="$(node -p "require('./packages/otto/package.json').version")"
            VERSION="${PACKAGE_VERSION}-nightly.${TIMESTAMP}+${SHORT_SHA}"
            RELEASE_NAME="Otto Nightly ${TIMESTAMP} (${SHORT_SHA})"
            PRERELEASE="true"
          fi

          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"

      - name: Quality checks
        run: pnpm run check

      - name: Sync build version
        run: pnpm run version:sync -- "${{ steps.meta.outputs.version }}"

      - name: Build
        run: pnpm run build

      - name: Package release artifact
        shell: bash
        run: |
          mkdir -p release
          mkdir -p release/stage/bin release/stage/scripts release/stage/control-plane
          chmod +x packages/otto/bin/ottoctl packages/otto/install.sh packages/otto/scripts/install-parakeet-v3.sh packages/otto/scripts/parakeet-worker.py
          cp -R packages/otto/dist release/stage/dist
          cp packages/otto/bin/ottoctl release/stage/bin/ottoctl
          cp packages/otto/scripts/resolve-release.mjs release/stage/scripts/resolve-release.mjs
          cp packages/otto/scripts/install-parakeet-v3.sh release/stage/scripts/install-parakeet-v3.sh
          cp packages/otto/scripts/parakeet-worker.py release/stage/scripts/parakeet-worker.py
          cp packages/otto/install.sh release/stage/install.sh
          cp packages/otto/package.json release/stage/package.json
          cp packages/otto/README.md release/stage/README.md
          pnpm --filter otto-control-plane --prod deploy --config.inject-workspace-packages=true --config.force-legacy-deploy=true release/stage/control-plane
          rm -rf release/stage/control-plane/app release/stage/control-plane/tests release/stage/control-plane/scripts release/stage/control-plane/.react-router release/stage/control-plane/README.md
          tar -czf "release/otto-${{ steps.meta.outputs.version }}.tgz" -C release/stage .

      - name: Validate release artifact layout
        shell: bash
        run: |
          ARCHIVE="release/otto-${{ steps.meta.outputs.version }}.tgz"
          tar -tzf "${ARCHIVE}" > release/archive-contents.txt

          required_paths=(
            "./dist/index.mjs"
            "./bin/ottoctl"
            "./scripts/resolve-release.mjs"
            "./scripts/install-parakeet-v3.sh"
            "./scripts/parakeet-worker.py"
            "./install.sh"
            "./package.json"
            "./README.md"
            "./control-plane/build/server/index.js"
            "./control-plane/build/client/assets/"
            "./control-plane/node_modules/@react-router/serve"
          )

          for required_path in "${required_paths[@]}"; do
            if ! grep -Fxq "${required_path}" release/archive-contents.txt; then
              echo "Missing required artifact path: ${required_path}" >&2
              exit 1
            fi
          done

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: ${{ steps.meta.outputs.release_name }}
          prerelease: ${{ steps.meta.outputs.prerelease == 'true' }}
          files: release/*.tgz
